<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ant Colony ‚Äî 3 Starters + More Fun</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg1:#f0d6a3; --bg2:#7c4a2a; --panel:rgba(10,10,12,0.56); --accent:#ffd54f;
    --muted:#d8d8d8;
  }
  html,body{height:100%;margin:0;background:#111;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;color:#eee}
  canvas{display:block; width:100vw; height:100vh; background: linear-gradient(180deg,var(--bg1),var(--bg2));}
  #ui{position:absolute; left:12px; top:12px; z-index:40; width:380px; display:flex; flex-direction:column; gap:10px;}
  .panel{background:var(--panel); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 8px 24px rgba(0,0,0,0.45);}
  #topRow{display:flex; justify-content:space-between; align-items:center;}
  #title{font-size:18px; color:var(--accent); font-weight:800}
  .muted{color:var(--muted); font-size:13px}
  #controls{font-size:12px; color:#ddd; margin-top:8px}
  #buttons{position:absolute; right:12px; top:12px; z-index:40; display:flex; flex-direction:column; gap:8px;}
  .btn{background:#222; color:#fff; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;}
  .ability{display:inline-block; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,0.3); margin-right:6px; font-size:13px}
  #panelUpgrades{position:absolute; right:12px; top:120px; z-index:41; width:360px; display:none;}
  #message{position:absolute; left:50%; transform:translateX(-50%); top:18px; z-index:42; padding:8px 14px; background:rgba(0,0,0,0.6); border-radius:8px; display:none;}
  footer{position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:12px; color:#ddd; opacity:0.9; z-index:20}
  @media (max-width:900px){ #ui{width:260px} #panelUpgrades{width:260px} }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="ui">
  <div class="panel" id="panelHeader">
    <div id="topRow">
      <div id="title">üêú Ant Colony ‚Äî Starter Pack</div>
      <div style="text-align:right">
        <div id="score" style="font-weight:700;color:var(--accent)">Score: 0</div>
        <div id="colonyFood" class="muted">Colony Food: 0</div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:10px">
      <div>
        <div id="activeAnt" style="font-weight:700">Active: ‚Äî</div>
        <div id="hpLine" class="muted">HP: ‚Äî / ‚Äî</div>
      </div>
      <div style="text-align:right">
        <div class="muted" id="antsCount">Ants: 0</div>
        <div class="muted" id="enemiesCount">Enemies: 0</div>
      </div>
    </div>

    <div style="margin-top:10px" class="muted">Controls: WASD / Arrows = Move ¬∑ Space = Attack ¬∑ Shift = Dash ¬∑ E = Pulse ¬∑ 1‚Äì6 = Switch</div>
    <div style="margin-top:8px">
      <span class="ability">Dash (Shift): <span id="dashCD">Ready</span></span>
      <span class="ability">Pulse (E): <span id="pulseCD">Ready</span></span>
    </div>

    <div style="margin-top:8px">
      <div class="muted">Starters: press 1 / 2 / 3 to switch</div>
      <div style="display:flex; gap:8px; margin-top:6px">
        <div id="starter1" class="ability">1: Worker</div>
        <div id="starter2" class="ability">2: Soldier</div>
        <div id="starter3" class="ability">3: Scout</div>
      </div>
    </div>
  </div>

  <div class="panel" id="panelStats">
    <div style="display:flex; justify-content:space-between">
      <div><div class="muted">Eggs</div><div id="eggsCount" style="font-weight:700">0</div></div>
      <div><div class="muted">Wave</div><div id="waveCount" style="font-weight:700">0</div></div>
      <div><div class="muted">Next</div><div id="nextWave" style="font-weight:700">‚Äî</div></div>
    </div>
  </div>
</div>

<div id="buttons">
  <button class="btn" id="startBtn">Start</button>
  <button class="btn" id="resetBtn">Reset</button>
  <button class="btn" id="upgradesBtn">Upgrades</button>
</div>

<div id="panelUpgrades" class="panel">
  <h3 style="margin:6px 0">Upgrades (colony food)</h3>
  <div style="display:flex; flex-direction:column; gap:8px;">
    <div style="display:flex;justify-content:space-between"><div>Queen fertility</div><div><button data-up="queenRate">40</button></div></div>
    <div style="display:flex;justify-content:space-between"><div>Worker speed</div><div><button data-up="workerSpeed">25</button></div></div>
    <div style="display:flex;justify-content:space-between"><div>Soldier damage</div><div><button data-up="soldierAtk">30</button></div></div>
  </div>
  <div style="margin-top:8px"><button id="closeUp">Close</button></div>
</div>

<div id="message"></div>
<footer>Ant Colony ‚Äî Have fun! (you start with 3 ants)</footer>

<script>
/* Full single-file Ant Colony ‚Äî 3 starter ants + additions
   - Player starts with 3 controllable ants (Worker, Soldier, Scout)
   - Fix: AI does not run for the active player ant (no auto-move)
   - Added: Hornet enemy, power-up crates, Dash (Shift), Pulse (E)
   - Upgrades panel (basic)
*/

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W = innerWidth, H = innerHeight;
function resize(){ W = innerWidth; H = innerHeight; canvas.width = W; canvas.height = H; }
addEventListener('resize', resize);
resize();

// UI refs
const activeAntEl = document.getElementById('activeAnt');
const hpLineEl = document.getElementById('hpLine');
const scoreEl = document.getElementById('score');
const colonyFoodEl = document.getElementById('colonyFood');
const antsCountEl = document.getElementById('antsCount');
const enemiesCountEl = document.getElementById('enemiesCount');
const eggsCountEl = document.getElementById('eggsCount');
const waveCountEl = document.getElementById('waveCount');
const nextWaveEl = document.getElementById('nextWave');
const dashCDEl = document.getElementById('dashCD');
const pulseCDEl = document.getElementById('pulseCD');
const panelUpgrades = document.getElementById('panelUpgrades');
const upgradesBtn = document.getElementById('upgradesBtn');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const closeUp = document.getElementById('closeUp');
const messageEl = document.getElementById('message');

// game state
let gameState = 'menu'; // 'playing'
let timer = 0;
let ants = [], enemies = [], foods = [], eggs = [], floats = [], crates = [];
let controllable = [], player = null, playerIndex = 0;
let colonyFood = 0, score = 0;
let wave = 0, waveTick = 0, waveInterval = 1800;
let upgrades = { queenRate:0, workerSpeed:0, soldierAtk:0 };

function showMessage(txt, ms=1400){ messageEl.textContent = txt; messageEl.style.display = 'block'; setTimeout(()=>messageEl.style.display = 'none', ms); }
function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function spawnFloat(x,y,txt,color='#fff'){ floats.push({x,y,txt,color,t:0}); }

// input (normalized)
const keys = {};
function setKey(k, v){ if(k.length === 1) k = k.toLowerCase(); keys[k]=v; }
addEventListener('keydown', e => { setKey(e.key, true); if(gameState==='playing' && ['1','2','3','4','5','6'].includes(e.key)){ const idx = parseInt(e.key)-1; if(controllable[idx]){ playerIndex = idx; player = controllable[idx]; showMessage('Switched to ' + player.type); } }});
addEventListener('keyup', e => setKey(e.key, false));

// Entities
class Food { constructor(x,y,amt=8){ this.x=x; this.y=y; this.size=6; this.amount=amt; this.collected=false; } draw(){ const bob = Math.sin(Date.now()/180 + this.x)*2; ctx.fillStyle = '#e84e4e'; ctx.beginPath(); ctx.ellipse(this.x, this.y + bob, this.size, this.size*0.75, 0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.stroke(); } }
class Crate { constructor(x,y){ this.x=x; this.y=y; this.size=10; this.t=0; } update(){ this.t++; } draw(){ ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.rect(this.x-this.size, this.y-this.size, this.size*2, this.size*2); ctx.fill(); ctx.strokeStyle='black'; ctx.stroke(); } }
class Egg { constructor(x,y){ this.x=x; this.y=y; this.t=0; this.hatch = Math.max(200, 600 - upgrades.queenRate*40); } update(){ this.t++; if(this.t>=this.hatch){ const types=['worker','soldier','scout','harvester','medic','defender','builder','fire','guardian']; const type = types[Math.floor(Math.random()*types.length)]; const a=new Ant(this.x+rand(-18,18), this.y+rand(-18,18), type); if(Math.random()<0.18){ a.mutated=true; a.color='#FFD700'; a.speed*=1.25; a.maxHealth=Math.ceil(a.maxHealth*1.4); a.health=a.maxHealth; } ants.push(a); if(['worker','soldier','scout','harvester','medic','defender','builder','fire','guardian'].includes(type)) controllable.push(a); eggs.splice(eggs.indexOf(this),1); spawnFloat(a.x,a.y-8,'HATCH','#fff'); } } draw(){ const grow = clamp(this.t/this.hatch,0,1); ctx.fillStyle='orange'; ctx.beginPath(); ctx.ellipse(this.x, this.y, 5*grow+1, 7*grow+1,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.stroke(); } }

class Ant {
  constructor(x,y,type='worker'){
    this.x=x; this.y=y; this.type=type; this.size=(type==='queen'?16:10); this.color=this.baseColor();
    this.mutated=false;
    this.speed = (type==='scout'?2.6: type==='soldier'?1.7:1.45) + (upgrades.workerSpeed||0);
    this.maxHealth = (type==='soldier'?6: type==='defender'?8: type==='guardian'?10: type==='fire'?3:3);
    this.health = this.maxHealth;
    this.carry = (type==='harvester'?2:1);
    this.target = null;
    this.attack = (type==='soldier'?1: type==='fire'?2:1);
    this.builderCooldown = 0;
  }
  baseColor(){
    switch(this.type){
      case 'queen': return '#7a2e7a';
      case 'soldier': return '#1e90ff';
      case 'scout': return '#ffa500';
      case 'harvester': return '#2e8b57';
      case 'defender': return '#8b0000';
      case 'medic': return '#00d676';
      case 'builder': return '#6e6e6e';
      case 'fire': return '#ff4500';
      case 'guardian': return '#4b0082';
      default: return '#8b4513';
    }
  }
  update(){
    // DO NOT run AI for the currently active player ant (fix)
    if(this === player) return;
    if(this.type === 'queen') return;
    if(this.type === 'builder'){
      if(this.builderCooldown > 0) this.builderCooldown--;
      else if(Math.random() < 0.002){ this.builderCooldown = 1000; spawnFloat(this.x,this.y-8,'BUILT','#ddd'); }
      if(!this.target || this.target.collected) this.target = foods.length ? foods[Math.floor(Math.random()*foods.length)] : null;
      if(this.target) this.moveTo(this.target.x, this.target.y);
    }
    if(this.type === 'worker' || this.type === 'harvester' || this.type === 'builder'){
      if(!this.target || this.target.collected) this.target = foods.length ? foods[Math.floor(Math.random()*foods.length)] : null;
      if(this.target){
        this.moveTo(this.target.x, this.target.y);
        if(Math.hypot(this.x-this.target.x, this.y-this.target.y) < 10){
          if(!this.target.collected){
            this.target.collected = true;
            colonyFood += this.carry * this.target.amount;
            score += this.carry * this.target.amount;
            spawnFloat(this.x, this.y-8, '+' + (this.carry*this.target.amount), '#ffd54f');
            this.target = null;
          }
        }
      }
    }
    if(this.type === 'soldier' || this.type === 'defender' || this.type === 'guardian' || this.type === 'fire'){
      const nearest = getClosestEnemy(this);
      if(nearest){
        this.moveTo(nearest.x, nearest.y);
        if(Math.hypot(this.x-nearest.x, this.y-nearest.y) < this.size + nearest.size + 4){
          nearest.takeDamage(this.attack + (this.mutated?1:0) + (upgrades.soldierAtk||0));
          spawnFloat(nearest.x, nearest.y-8, 'DMG', '#ff8a8a');
        }
      }
    }
    if(this.type === 'scout'){
      if(!this.target || Math.random() < 0.01) this.target = {x: rand(40,W-40), y: rand(40,H-40)};
      if(this.target) this.moveTo(this.target.x, this.target.y);
    }
    if(this.type === 'medic'){
      for(let a of ants){
        if(a !== this && Math.hypot(a.x-this.x, a.y-this.y) < 36 && a.health < a.maxHealth){
          a.health = Math.min(a.maxHealth, a.health + 0.02);
        }
      }
    }
    // clamp
    this.x = clamp(this.x, 8, W-8);
    this.y = clamp(this.y, 8, H-8);
  }
  moveTo(tx,ty){
    const dx = tx - this.x, dy = ty - this.y;
    const d = Math.hypot(dx,dy);
    if(d>0.5){ this.x += (dx/d) * this.speed; this.y += (dy/d) * this.speed; }
  }
  takeDamage(d){
    this.health -= d;
    spawnFloat(this.x,this.y-8, '-' + d, '#ffa07a');
    if(this.health <= 0){
      const idx = ants.indexOf(this); if(idx>=0) ants.splice(idx,1);
      const ci = controllable.indexOf(this); if(ci>=0) controllable.splice(ci,1);
      if(player === this){
        if(controllable.length){ playerIndex = 0; player = controllable[0]; showMessage('Your active ant died ‚Äî switched'); }
        else { player = null; showMessage('Active ant died'); }
      }
    }
  }
  draw(){
    ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.16)'; ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size*0.36,0,Math.PI*2); ctx.fill();
    const bw = this.size*2;
    ctx.fillStyle='red'; ctx.fillRect(this.x - this.size, this.y - this.size - 8, bw * (this.health/this.maxHealth), 4);
    ctx.strokeStyle='black'; ctx.strokeRect(this.x - this.size, this.y - this.size - 8, bw, 4);
    if(this.mutated){ ctx.strokeStyle='#ffd70088'; ctx.beginPath(); ctx.arc(this.x,this.y,this.size+4,0,Math.PI*2); ctx.stroke(); }
  }
}

class Enemy {
  constructor(x,y,type='spider'){
    this.x = x; this.y = y; this.type = type;
    this.size = (type==='beetle'?14: type==='hornet'?11:10);
    this.color = (type==='beetle'?'#6b3e2b': type==='wasp'?'#e1c542': type==='hornet'?'#7f0':'#7b2626');
    this.maxHealth = (type==='beetle'?6: type==='wasp'?2: type==='hornet'?4:3);
    this.health = this.maxHealth;
    this.speed = (type==='beetle'?0.6: type==='wasp'?2.2: type==='hornet'?1.8: 1.0);
    this.mutated = false;
  }
  update(){
    if(ants.length === 0) return;
    const target = ants.find(a=>a.type==='queen') || ants[Math.floor(Math.random()*ants.length)];
    const dx = target.x - this.x, dy = target.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d>0.5){ this.x += (dx/d) * this.speed; this.y += (dy/d) * this.speed; }
    if(d < this.size + target.size + 2){
      target.takeDamage( this.type==='wasp'? 0.6 : 0.12 );
    }
  }
  takeDamage(d){
    this.health -= d; spawnFloat(this.x,this.y-8, '-' + d, '#ff8a8a');
    if(this.health <= 0){
      if(Math.random() < 0.5) foods.push(new Food(this.x + rand(-12,12), this.y + rand(-12,12), 8));
      const i = enemies.indexOf(this); if(i>=0) enemies.splice(i,1);
      score += 5;
    }
  }
  draw(){
    const bob = Math.sin(Date.now()/180 + this.x)*2;
    ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y + bob, this.size, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='black'; ctx.stroke();
    ctx.fillStyle='red'; ctx.fillRect(this.x - this.size, this.y - this.size - 6, this.size*2 * (this.health/this.maxHealth), 4);
    ctx.strokeStyle='black'; ctx.strokeRect(this.x - this.size, this.y - this.size - 6, this.size*2, 4);
    if(this.mutated){ ctx.strokeStyle='#80000066'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size+4, 0, Math.PI*2); ctx.stroke(); }
  }
}

// utilities
function getClosestEnemy(from){
  if(enemies.length === 0) return null;
  let best = enemies[0], bd = Math.hypot(enemies[0].x - from.x, enemies[0].y - from.y);
  for(let e of enemies){ const d = Math.hypot(e.x-from.x, e.y-from.y); if(d < bd){ bd = d; best = e; } }
  return best;
}

// spawns
function spawnEnemyRandom(){
  const roll = Math.random();
  let t = 'spider';
  if(roll < 0.55) t = 'spider';
  else if(roll < 0.8) t = 'beetle';
  else if(roll < 0.95) t = 'wasp';
  else t = 'hornet';
  const e = new Enemy(rand(60,W-60), rand(60,H-60), t);
  if(Math.random() < 0.12){ e.mutated=true; e.maxHealth*=1.4; e.health=e.maxHealth; e.speed*=1.12; }
  enemies.push(e);
}
function spawnFoodRandom(){ foods.push(new Food(rand(40,W-40), rand(40,H-40), 8)); }
function spawnCrateRandom(){ if(Math.random() < 0.02) crates.push(new Crate(rand(60,W-60), rand(60,H-60))); }

// abilities & cooldowns
let lastDash = 0, lastPulse = 0;
function doDash(){
  const now = performance.now();
  if(now - lastDash < 700) return;
  lastDash = now;
  if(!player) return;
  // dash in input direction (or forward)
  let dx=0, dy=0;
  if(keys['w']||keys['arrowup']) dy -=1;
  if(keys['s']||keys['arrowdown']) dy +=1;
  if(keys['a']||keys['arrowleft']) dx -=1;
  if(keys['d']||keys['arrowright']) dx +=1;
  if(dx===0 && dy===0) { dx=1; } // default dash right if idle
  const d = Math.hypot(dx,dy);
  const dist = 100;
  player.x += (dx/d)*dist; player.y += (dy/d)*dist;
  // damage enemies in path
  for(let e of enemies.slice()){
    if(Math.hypot(e.x - player.x, e.y - player.y) < player.size + e.size + 12){ e.takeDamage(2); }
  }
}
function doPulse(){
  const now = performance.now();
  if(now - lastPulse < 2000) return;
  lastPulse = now;
  if(!player) return;
  const r = 110;
  for(let e of enemies.slice()){
    if(Math.hypot(e.x - player.x, e.y - player.y) <= r) e.takeDamage(2);
  }
  for(let i=0;i<12;i++) spawnFloat(player.x + rand(-r,r), player.y + rand(-r,r), 'P', '#ffd54f');
}

// Start / Reset logic ‚Äî player starts with 3 starters
function startGame(){
  ants = []; enemies = []; foods = []; eggs = []; floats = []; crates = []; controllable = [];
  colonyFood = 120; score = 0; timer = 0; wave = 0; waveTick = 0;
  upgrades = { queenRate:0, workerSpeed:0, soldierAtk:0 };
  // queen at center
  const queen = new Ant(W/2, H/2, 'queen'); queen.maxHealth = 28; queen.health = 28; ants.push(queen);
  // 3 starter ants: Worker, Soldier, Scout
  const s1 = new Ant(W/2 + 70, H/2, 'worker'); const s2 = new Ant(W/2 + 40, H/2 + 40, 'soldier'); const s3 = new Ant(W/2 - 60, H/2 + 10, 'scout');
  ants.push(s1, s2, s3);
  controllable.push(s1, s2, s3);
  playerIndex = 0; player = controllable[playerIndex];
  // initial environment
  for(let i=0;i<10;i++) foods.push(new Food(rand(80,W-80), rand(80,H-80)));
  for(let i=0;i<4;i++) spawnEnemyRandom();
  gameState = 'playing';
  showMessage('Started with 3 starter ants! Use 1-3 to switch.');
}

// canvas click: collect crates or spawn food
canvas.addEventListener('click', e=>{
  if(gameState !== 'playing') return;
  const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top;
  // pick up crates if close
  for(let i=crates.length-1;i>=0;i--){
    const c = crates[i]; if(Math.hypot(c.x-x, c.y-y) < 30){ // player clicked near crate
      // random crate effect
      const eff = Math.random();
      if(eff < 0.33){ // speed boost
        if(player) { player.speed *= 1.4; setTimeout(()=>{ if(player) player.speed /= 1.4; }, 8000); showMessage('Speed boost!'); }
      } else if(eff < 0.66){ // heal
        if(player){ player.health = Math.min(player.maxHealth, player.health + 4); showMessage('Healed!'); }
      } else { colonyFood += 40; showMessage('Big food! +40'); }
      crates.splice(i,1);
      return;
    }
  }
  // otherwise spawn food where clicked
  foods.push(new Food(x,y,8));
});

// keyboard abilities: Shift dash, E pulse
addEventListener('keydown', e=>{
  if(gameState !== 'playing') return;
  if(e.key === 'Shift') doDash();
  if(e.key === 'e' || e.key === 'E') doPulse();
});

// upgrades UI
upgradesBtn.addEventListener('click', ()=> panelUpgrades.style.display = panelUpgrades.style.display === 'none' ? 'block' : 'none');
closeUp.addEventListener('click', ()=> panelUpgrades.style.display = 'none');
panelUpgrades.querySelectorAll('button').forEach((btn,i)=>{
  const keysMap = ['queenRate','workerSpeed','soldierAtk']; const costs = {queenRate:40, workerSpeed:25, soldierAtk:30};
  btn.addEventListener('click', ()=>{
    const up = keysMap[i]; const cost = costs[up];
    if(colonyFood < cost) { showMessage('Not enough colony food'); return; }
    colonyFood -= cost; upgrades[up] = (upgrades[up]||0)+1;
    if(up==='workerSpeed'){ ants.forEach(a=>{ if(a.type==='worker') a.speed += 0.3; }); showMessage('Workers faster'); }
    else showMessage('Upgrade bought');
  });
});

// Start/Reset buttons
startBtn.addEventListener('click', startGame);
resetBtn.addEventListener('click', ()=>{ startGame(); showMessage('Reset'); });

// spawn tick helpers
let spawnTick = 0;
function spawnTickFuncs(){
  spawnTick++;
  if(spawnTick % 90 === 0) spawnFoodRandom();
  if(spawnTick % 160 === 0) spawnEnemyRandom();
  if(spawnTick % 900 === 0) spawnCrateRandom();
}

// wave system
let waveTickCounter = 0;
function handleWaves(){
  waveTickCounter++;
  nextWaveEl.textContent = Math.max(0, Math.round((waveInterval - waveTickCounter)/60)) + 's';
  if(waveTickCounter >= waveInterval){
    wave++; waveTickCounter = 0; const count = 3 + Math.floor(wave*1.3);
    for(let i=0;i<count;i++) spawnEnemyRandom();
    if(wave % 4 === 0){ const b = new Enemy(rand(120,W-120), rand(120,H-120), 'beetle'); b.maxHealth *= 3; b.health = b.maxHealth; b.size *= 1.6; b.mutated = true; enemies.push(b); showMessage('Boss wave!'); }
    else showMessage('Wave ' + wave);
  }
}

// main loop & rendering
let last = performance.now();
function loop(now){
  requestAnimationFrame(loop);
  const dt = (now - last) / 16.666; last = now;
  if(gameState !== 'playing'){
    // draw preview scenes if desired
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#f0d6a3'); g.addColorStop(1,'#7c4a2a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    for(let f of foods) f.draw();
    for(let a of ants) a.draw();
    for(let e of enemies) e.draw();
    return;
  }

  timer++; spawnTickFuncs(); handleWaves();

  // update entities
  for(let a of ants) a.update();
  for(let e of enemies) e.update();
  for(let c of crates) c.update();
  for(let i=eggs.length-1;i>=0;i--) eggs[i].update();

  // update floats
  for(let i=floats.length-1;i>=0;i--){ floats[i].t++; if(floats[i].t > 60) floats.splice(i,1); }

  // player movement (only if keys pressed) - fixes drifting
  if(player){
    let dx=0, dy=0;
    if(keys['w'] || keys['arrowup']) dy -=1;
    if(keys['s'] || keys['arrowdown']) dy +=1;
    if(keys['a'] || keys['arrowleft']) dx -=1;
    if(keys['d'] || keys['arrowright']) dx +=1;
    if(dx !== 0 || dy !== 0){
      const mag = Math.hypot(dx,dy);
      player.x += (dx/mag) * player.speed;
      player.y += (dy/mag) * player.speed;
    }
  }

  // collisions: crates (auto-pick when near)
  for(let i=crates.length-1;i>=0;i--){
    const c = crates[i];
    // if player near, auto-collect
    if(player && Math.hypot(player.x - c.x, player.y - c.y) < 28){
      const eff = Math.random();
      if(eff < 0.33){ player.speed *= 1.4; setTimeout(()=>{ if(player) player.speed /= 1.4; }, 8000); showMessage('Speed boost!'); }
      else if(eff < 0.66){ if(player){ player.health = Math.min(player.maxHealth, player.health + 6); showMessage('Healed!'); } }
      else { colonyFood += 40; showMessage('Golden food +40'); }
      crates.splice(i,1);
    }
  }

  // render
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#f0d6a3'); g.addColorStop(1,'#7c4a2a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  for(let f of foods) if(!f.collected) f.draw();
  for(let c of crates) c.draw();
  for(let eg of eggs) eg.draw();
  for(let a of ants) a.draw();
  for(let e of enemies) e.draw();
  // floats
  for(let i=0;i<floats.length;i++){ const d = floats[i]; ctx.font='14px sans-serif'; ctx.fillStyle = d.color; ctx.fillText(d.txt, d.x, d.y - (d.t*0.6)); }

  // update UI info
  activeAntEl.textContent = 'Active: ' + (player ? player.type.toUpperCase() : '‚Äî');
  hpLineEl.textContent = player ? `HP: ${Math.round(player.health)}/${player.maxHealth}` : 'HP: ‚Äî';
  scoreEl.textContent = 'Score: ' + score;
  colonyFoodEl.textContent = 'Colony Food: ' + Math.round(colonyFood);
  antsCountEl.textContent = ants.length;
  enemiesCountEl.textContent = enemies.length;
  eggsCountEl.textContent = eggs.length;
  waveCountEl.textContent = wave;

  // ability cooldown displays
  dashCDEl.textContent = (performance.now() - lastDash > 700) ? 'Ready' : Math.ceil((700 - (performance.now() - lastDash)) / 100) + '0ms';
  pulseCDEl.textContent = (performance.now() - lastPulse > 2000) ? 'Ready' : Math.ceil((2000 - (performance.now() - lastPulse)) / 100) + '0ms';
}

// quick utility spawns at idle so menu looks nice
(function preview(){
  foods = []; ants = []; enemies = []; eggs = []; floats = []; crates = [];
  const q = new Ant(W/2, H/2, 'queen'); ants.push(q);
  const p1 = new Ant(W/2+60, H/2, 'worker'); const p2 = new Ant(W/2+40, H/2+40, 'soldier'); const p3 = new Ant(W/2-60, H/2+10, 'scout');
  ants.push(p1,p2,p3); controllable.push(p1,p2,p3); player = p1;
  for(let i=0;i<6;i++) foods.push(new Food(rand(80,W-80), rand(80,H-80)));
  enemies.push(new Enemy(rand(120,W-120), rand(120,H-120), 'spider'));
})();

requestAnimationFrame(loop);

// Allow abilities via keyboard - separate so input doesn't conflict
addEventListener('keydown', e=>{
  if(gameState !== 'playing') return;
  if(e.key === 'Shift') doDash();
  if(e.key === 'e' || e.key === 'E') doPulse();
});
function doDash(){ /* wrapper uses lastDash/lastPulse defined above */ const now = performance.now(); if(now - lastDash < 700) return; lastDash = now; if(!player) return; let dx=0, dy=0; if(keys['w']||keys['arrowup']) dy -=1; if(keys['s']||keys['arrowdown']) dy +=1; if(keys['a']||keys['arrowleft']) dx -=1; if(keys['d']||keys['arrowright']) dx +=1; if(dx===0 && dy===0){ dx=1; } const d=Math.hypot(dx,dy); player.x += (dx/d)*100; player.y += (dy/d)*100; for(let e of enemies.slice()) if(Math.hypot(e.x-player.x,e.y-player.y) < player.size + e.size + 12) e.takeDamage(2 + (upgrades.playerAtk||0)); showMessage('Dash'); }
function doPulse(){ const now = performance.now(); if(now - lastPulse < 2000) return; lastPulse = now; if(!player) return; const r=110; for(let e of enemies.slice()) if(Math.hypot(e.x-player.x,e.y-player.y) <= r) e.takeDamage(2 + (upgrades.playerAtk||0)); for(let i=0;i<8;i++) spawnFloat(player.x+rand(-r,r), player.y+rand(-r,r), 'P', '#ffd54f'); showMessage('Pulse'); }

// make sure 1-3 starter buttons present: not clickable but show labels (UI above)
// done in HTML

</script>
</body>
</html>
