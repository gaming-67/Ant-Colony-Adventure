<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ant Colony ‚Äî Smooth Edition (Queen Feeding)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg-top: #f3e7c9;
    --bg-bottom: #7a4f34;
    --panel: rgba(18,18,20,0.6);
    --accent: #ffd54f;
    --muted: #d4d4d4;
  }
  html,body{height:100%;margin:0;background:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eee}
  canvas{display:block; width:100vw; height:100vh; background: linear-gradient(180deg,var(--bg-top),var(--bg-bottom));}
  /* UI */
  #ui { position:absolute; left:12px; top:12px; width:360px; z-index:40; display:flex; flex-direction:column; gap:10px; }
  .panel { background:var(--panel); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 30px rgba(0,0,0,0.45); }
  #controls { font-size:13px; color:var(--muted); margin-top:8px; }
  #buttons { position:absolute; right:12px; top:12px; z-index:40; display:flex; flex-direction:column; gap:8px; }
  .btn { background:#222; color:#fff; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
  #menuOverlay, #gameOverOverlay, #instructionsOverlay, #updatesOverlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:100; background:rgba(0,0,0,0.7); }
  #menuCard, #gameOverCard, #instrCard, #updCard { width:520px; max-width:94%; background:#0f0f0f; padding:20px; border-radius:12px; text-align:center; }
  #message { position:absolute; left:50%; transform:translateX(-50%); top:18px; z-index:50; padding:8px 12px; background:rgba(0,0,0,0.6); border-radius:8px; display:none; font-weight:700; }
  footer { position:absolute; bottom:8px; left:50%; transform:translateX(-50%); font-size:12px; color:#ddd; z-index:20; }
  @media (max-width:900px){ #ui{width:260px} }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<!-- UI -->
<div id="ui">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;color:var(--accent)">üêú Ant Colony ‚Äî Smooth</div>
      <div style="text-align:right">
        <div id="score" style="font-weight:800;color:var(--accent)">Score: 0</div>
        <div id="colFood" style="font-size:13px;color:var(--muted)">Food: 0</div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <div>
        <div id="activeType" style="font-weight:800">Active: ‚Äî</div>
        <div id="hpLine" style="font-size:13px;color:var(--muted)">HP: ‚Äî / ‚Äî</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:var(--muted)">Ants: <span id="antsCount">0</span></div>
        <div style="font-size:13px;color:var(--muted)">Enemies: <span id="enemiesCount">0</span></div>
      </div>
    </div>

    <div id="controls">
      Controls: WASD / Arrows = Move ¬∑ Space = Attack ¬∑ F = Feed Queen (near) ¬∑ 1‚Äì3 = Switch starters ¬∑ B = Main Menu
    </div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:13px;color:var(--muted)">Queen</div>
        <div id="qHealth" style="font-weight:800">HP: ‚Äî</div>
      </div>
      <div style="width:190px">
        <div style="font-size:13px;color:var(--muted)">Hunger</div>
        <div style="background:rgba(0,0,0,0.18); height:14px; border-radius:8px; overflow:hidden;">
          <div id="qHungerBar" style="height:100%; width:100%; background:linear-gradient(90deg,#ff8b8b,#ffd54f)"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">Feed queen with F (must be near & colony food available)</div>
      </div>
    </div>
  </div>
</div>

<!-- Buttons -->
<div id="buttons">
  <button class="btn" id="startBtn">Start</button>
  <button class="btn" id="instructionsBtn">Instructions</button>
  <button class="btn" id="updatesBtn">Updates</button>
</div>

<div id="message"></div>
<footer>Ant Colony ‚Äî Smooth shapes style</footer>

<!-- Overlays -->
<div id="menuOverlay" style="display:flex">
  <div id="menuCard">
    <h1 style="margin:6px 0 12px 0">Ant Colony ‚Äî Smooth</h1>
    <p style="color:#ddd">Protect your Queen, collect food to feed her, raise ants, and survive waves.</p>
    <div style="display:flex;justify-content:center;gap:12px;margin-top:12px">
      <button class="btn" id="menuStart">Start Game</button>
      <button class="btn" id="menuInstr">Instructions</button>
      <button class="btn" id="menuUpdates">Updates</button>
    </div>
  </div>
</div>

<div id="instructionsOverlay" style="display:none">
  <div id="instrCard">
    <h2>Instructions</h2>
    <p style="color:#ddd; text-align:left; max-width:480px; margin:8px auto;">
      - Move with WASD / Arrow keys. <br>
      - Collect food (walk over pieces) ‚Äî each piece adds to colony Food. <br>
      - When near the Queen, press <b>F</b> to feed her (consumes colony food). <br>
      - Queen needs food to lay eggs ‚Äî if hunger reaches 0 she will die (Game Over). <br>
      - Press <b>Space</b> to attack nearby enemies. <br>
      - Switch starter ants with <b>1</b>, <b>2</b>, <b>3</b>. <br>
      - Defend the Queen and grow your colony!
    </p>
    <div style="margin-top:12px">
      <button class="btn" id="instrBack">Back</button>
    </div>
  </div>
</div>

<div id="updatesOverlay" style="display:none">
  <div id="updCard">
    <h2>Updates</h2>
    <ul style="text-align:left; color:#ddd; max-width:480px; margin:8px auto;">
      <li>Added food collection: player & workers must collect food to feed the Queen.</li>
      <li>Queen hunger and feeding system implemented.</li>
      <li>Smooth modern shapes art style, improved UI.</li>
    </ul>
    <div style="margin-top:12px">
      <button class="btn" id="updBack">Back</button>
    </div>
  </div>
</div>

<div id="gameOverOverlay" style="display:none; align-items:center; justify-content:center;">
  <div id="gameOverCard">
    <h2 id="goTitle">Game Over</h2>
    <p id="goText" style="color:#ddd">The Queen has perished. The colony collapses.</p>
    <div style="display:flex;justify-content:center;gap:12px;margin-top:12px">
      <button class="btn" id="goRestart">Restart</button>
      <button class="btn" id="goMenu">Main Menu</button>
    </div>
    <div style="margin-top:10px;color:#ccc">Score: <span id="goScore">0</span> ¬∑ Waves: <span id="goWaves">0</span> ¬∑ Ants: <span id="goAnts">0</span></div>
  </div>
</div>

<script>
/* Ant Colony ‚Äî Smooth Edition
   - Food must be collected to feed the Queen (F near queen consumes colonyFood)
   - Queen has hunger; if hunger=0 -> health drains -> Game Over
   - Player starts with 3 ants (worker, soldier, scout), switchable with 1-3
   - Workers auto-collect food when they walk over it and deposit to colony (increase colonyFood)
   - No drifting: player moves only when movement keys held
   - Smooth modern shapes and clean UI
*/

// Canvas setup
const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
let W = innerWidth, H = innerHeight;
function resize(){ W = innerWidth; H = innerHeight; canvas.width = W; canvas.height = H; }
addEventListener('resize', resize);
resize();

// UI refs
const scoreEl = document.getElementById('score');
const colFoodEl = document.getElementById('colFood');
const activeTypeEl = document.getElementById('activeType');
const hpLineEl = document.getElementById('hpLine');
const antsCountEl = document.getElementById('antsCount');
const enemiesCountEl = document.getElementById('enemiesCount');
const qHealthEl = document.getElementById('qHealth');
const qHungerBar = document.getElementById('qHungerBar');
const msgEl = document.getElementById('message');

const menuOverlay = document.getElementById('menuOverlay');
const instructionsOverlay = document.getElementById('instructionsOverlay');
const updatesOverlay = document.getElementById('updatesOverlay');
const gameOverOverlay = document.getElementById('gameOverOverlay');
const goScore = document.getElementById('goScore'), goWaves = document.getElementById('goWaves'), goAnts = document.getElementById('goAnts');

// Buttons
document.getElementById('startBtn').onclick = startGame;
document.getElementById('menuStart').onclick = startGame;
document.getElementById('instructionsBtn').onclick = ()=> showInstructions();
document.getElementById('menuInstr').onclick = ()=> showInstructions();
document.getElementById('menuUpdates').onclick = ()=> showUpdates();
document.getElementById('instrBack').onclick = ()=> hideInstructions();
document.getElementById('updBack').onclick = ()=> hideUpdates();
document.getElementById('updatesBtn').onclick = ()=> showUpdates();
document.getElementById('goRestart').onclick = startGame;
document.getElementById('goMenu').onclick = showMenu;

// State
let gameState = 'menu'; // menu, playing, gameover
let timer = 0;
let ants = [], enemies = [], foods = [], eggs = [], floats = [], crates = [];
let player = null, controllable = [], playerIndex = 0;
let colonyFood = 0, score = 0, wave = 0, waveTimer = 0, waveInterval = 1600;
let queen = null;
let lastDash = 0, lastPulse = 0;
let keys = {};

// Utility
function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function showMsg(t, ms=1200){ msgEl.textContent = t; msgEl.style.display = 'block'; setTimeout(()=> msgEl.style.display = 'none', ms); }
function spawnFloat(x,y,text,color='#fff'){ floats.push({x,y,text,color,t:0}); }

// Input
function setKey(k, val){ if(k.length===1) k=k.toLowerCase(); keys[k]=val; }
addEventListener('keydown', e => {
  setKey(e.key, true);
  if(gameState === 'playing' && ['1','2','3','4','5','6'].includes(e.key)){
    const i = parseInt(e.key)-1;
    if(controllable[i]) { playerIndex = i; player = controllable[playerIndex]; showMsg('Switched to ' + player.type); }
  }
  if(e.key === 'f' || e.key === 'F') feedQueen();
  if(e.key === 'b' || e.key === 'B') showMenu();
  if(e.key === 'Shift') dash();
  if(e.key === 'e' || e.key === 'E') pulse();
});
addEventListener('keyup', e => setKey(e.key,false));

// Entities (smooth shapes)
class Food {
  constructor(x,y,amt=5,golden=false){ this.x=x; this.y=y; this.amount=amt; this.size = golden?10:6; this.golden = !!golden; this.picked=false; }
  draw(){
    const bob = Math.sin(Date.now()/200 + this.x)*2;
    ctx.beginPath();
    ctx.fillStyle = this.golden ? '#ffd76b' : '#ff7b7b';
    roundRect(ctx, this.x - this.size, this.y + bob - this.size*0.6, this.size*2, this.size*1.4, this.size*0.4, true, false);
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.stroke();
  }
}

class Egg {
  constructor(x,y){ this.x=x; this.y=y; this.t=0; this.hatch = 480; }
  update(){
    this.t++;
    if(this.t >= this.hatch){
      this.hatchNow();
    }
  }
  hatchNow(){
    const types = ['worker','soldier','scout','harvester'];
    const type = types[Math.floor(Math.random()*types.length)];
    const a = new Ant(this.x + rand(-12,12), this.y + rand(-12,12), type);
    if(Math.random() < 0.16){ a.mutated = true; a.speed *= 1.2; a.maxHealth = Math.ceil(a.maxHealth*1.4); a.health = a.maxHealth; a.color = '#ffd54f'; }
    ants.push(a);
    controllable.push(a);
    eggs.splice(eggs.indexOf(this),1);
    spawnFloat(a.x, a.y-8, 'Egg Hatched!', '#fff');
  }
  draw(){
    const grow = clamp(this.t / this.hatch, 0, 1);
    ctx.beginPath();
    ctx.fillStyle = '#ffb84d';
    ctx.ellipse(this.x, this.y, 6*grow+1, 8*grow+1, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.stroke();
  }
}

class Ant {
  constructor(x,y,type='worker'){
    this.x=x; this.y=y; this.type=type; this.size = (type==='queen'?18:10);
    this.color = this.getColor();
    this.mutated = false;
    this.speed = (type==='scout'?2.6: type==='soldier'?1.7:1.45);
    this.maxHealth = (type==='soldier'?6:3);
    this.health = this.maxHealth;
    this.carrying = 0; // workers pick up and deposit to colonyFood
    this.target = null;
  }
  getColor(){
    switch(this.type){
      case 'queen': return '#7a2e7a';
      case 'soldier': return '#1e90ff';
      case 'scout': return '#ffa500';
      case 'harvester': return '#2e8b57';
      default: return '#8b4513';
    }
  }
  update(){
    // if player-controlled, skip AI
    if(this === player) return;

    // worker logic
    if(this.type === 'worker' || this.type === 'harvester'){
      if(this.carrying > 0){
        // go to queen to deposit
        this.moveTo(queen.x, queen.y);
        if(Math.hypot(this.x-queen.x, this.y-queen.y) < 18){
          colonyFood += this.carrying;
          spawnFloat(queen.x, queen.y-10, '+' + this.carrying + ' Food', '#ffd54f');
          this.carrying = 0;
        }
        return;
      }
      // find nearest food
      if(!this.target || this.target.picked) this.target = findNearestFood(this);
      if(this.target){
        this.moveTo(this.target.x, this.target.y);
        if(Math.hypot(this.x - this.target.x, this.y - this.target.y) < 10){
          if(!this.target.picked){
            this.target.picked = true;
            this.carrying = this.target.amount;
            spawnFloat(this.x, this.y-8, 'Picked', '#ffd54f');
            // remove the food object (workers hold it until deposit)
            const idx = foods.indexOf(this.target); if(idx>=0) foods.splice(idx,1);
            this.target = null;
          }
        }
      }
      return;
    }

    // soldiers hunt
    if(this.type === 'soldier'){
      const nearest = getClosestEnemy(this);
      if(nearest){
        this.moveTo(nearest.x, nearest.y);
        if(Math.hypot(this.x - nearest.x, this.y - nearest.y) < this.size + nearest.size + 4){
          nearest.takeDamage(1 + (this.mutated?1:0));
        }
      }
      return;
    }

    // scout roams
    if(this.type === 'scout'){
      if(!this.target || Math.random() < 0.01) this.target = {x: rand(40, W-40), y: rand(40, H-40)};
      this.moveTo(this.target.x, this.target.y);
      return;
    }
  }
  moveTo(tx,ty){
    const dx = tx - this.x, dy = ty - this.y;
    const d = Math.hypot(dx,dy);
    if(d > 0.5){ this.x += (dx/d) * this.speed; this.y += (dy/d) * this.speed; }
  }
  takeDamage(d){
    this.health -= d;
    spawnFloat(this.x, this.y-8, '-' + Math.round(d), '#ff8a8a');
    if(this.health <= 0){
      const idx = ants.indexOf(this); if(idx>=0) ants.splice(idx,1);
      const ci = controllable.indexOf(this); if(ci>=0) controllable.splice(ci,1);
      if(this === queen){
        // queen death handled elsewhere
      } else {
        if(this === player){
          if(controllable.length) { playerIndex = 0; player = controllable[0]; showMsg('Active ant died ‚Äî switched'); }
          else player = null;
        }
      }
    }
  }
  draw(){
    // smooth round ant body
    ctx.beginPath();
    ctx.fillStyle = this.color;
    ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.stroke();
    // inner circle for subtle modern style
    ctx.beginPath();
    ctx.fillStyle='rgba(0,0,0,0.08)'; ctx.arc(this.x, this.y, this.size*0.36, 0, Math.PI*2); ctx.fill();
    // health bar
    const bw = this.size * 1.8;
    ctx.fillStyle = 'red';
    ctx.fillRect(this.x - this.size, this.y - this.size - 8, bw * (this.health / this.maxHealth), 4);
    ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.strokeRect(this.x - this.size, this.y - this.size - 8, bw, 4);
    // mutated glow
    if(this.mutated){ ctx.strokeStyle = '#ffd54f88'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size + 4, 0, Math.PI*2); ctx.stroke(); }
  }
}

class Enemy {
  constructor(x,y,type='spider'){
    this.x = x; this.y = y; this.type = type;
    this.size = 10; this.color = '#7b2626'; this.maxHealth = 3; this.health = 3; this.speed = 1.0;
    if(type === 'beetle'){ this.size = 14; this.color = '#6b3e2b'; this.maxHealth = 6; this.health = 6; this.speed = 0.6; }
    if(type === 'wasp'){ this.size = 9; this.color = '#e1c542'; this.maxHealth = 2; this.health = 2; this.speed = 2.2; }
  }
  update(){
    if(ants.length === 0) return;
    // prefer queen if nearby
    let target = queen && Math.hypot(queen.x - this.x, queen.y - this.y) < 220 ? queen : ants[Math.floor(Math.random()*ants.length)];
    if(!target) return;
    const dx = target.x - this.x, dy = target.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d > 0.5){ this.x += (dx/d) * this.speed; this.y += (dy/d) * this.speed; }
    if(d < this.size + target.size + 3){
      target.takeDamage(this.type === 'wasp' ? 0.6 : 0.12);
    }
  }
  takeDamage(d){
    this.health -= d;
    spawnFloat(this.x, this.y-8, '-' + Math.round(d), '#ff8a8a');
    if(this.health <= 0){
      const i = enemies.indexOf(this); if(i>=0) enemies.splice(i,1);
      // drop food sometimes
      if(Math.random() < 0.5) foods.push(new Food(this.x + rand(-8,8), this.y + rand(-8,8), 5, Math.random()<0.12));
      score += 5;
    }
  }
  draw(){
    const bob = Math.sin(Date.now()/180 + this.x)*2;
    ctx.beginPath();
    ctx.fillStyle = this.color;
    ctx.arc(this.x, this.y + bob, this.size, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.12)'; ctx.stroke();
    ctx.fillStyle='red'; ctx.fillRect(this.x - this.size, this.y - this.size - 6, this.size*2 * (this.health/this.maxHealth), 4);
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.strokeRect(this.x - this.size, this.y - this.size - 6, this.size*2, 4);
  }
}

// Helpers: find nearest food
function findNearestFood(from){
  if(foods.length === 0) return null;
  let best = foods[0], bd = Math.hypot(foods[0].x - from.x, foods[0].y - from.y);
  for(const f of foods){ const d = Math.hypot(f.x - from.x, f.y - from.y); if(d < bd){ bd = d; best = f; } }
  return best;
}
function getClosestEnemy(from){
  if(enemies.length === 0) return null;
  let best = enemies[0], bd = Math.hypot(enemies[0].x - from.x, enemies[0].y - from.y);
  for(const e of enemies){ const d = Math.hypot(e.x - from.x, e.y - from.y); if(d < bd){ bd = d; best = e; } }
  return best;
}

// Spawns
function spawnFoodRandom(){
  // mostly normal food, small chance golden
  if(Math.random() < 0.06) foods.push(new Food(rand(40,W-40), rand(40,H-40), 20, true));
  else foods.push(new Food(rand(40,W-40), rand(40,H-40), 5, false));
}
function spawnEnemyRandom(){
  const r = Math.random();
  if(r < 0.6) enemies.push(new Enemy(rand(60,W-60), rand(60,H-60), 'spider'));
  else if(r < 0.9) enemies.push(new Enemy(rand(60,W-60), rand(60,H-60), 'beetle'));
  else enemies.push(new Enemy(rand(60,W-60), rand(60,H-60), 'wasp'));
}

// Abilities
function dash(){
  const now = performance.now();
  if(now - lastDash < 700) return;
  lastDash = now;
  if(!player) return;
  let dx=0, dy=0;
  if(keys['w']||keys['arrowup']) dy -= 1;
  if(keys['s']||keys['arrowdown']) dy += 1;
  if(keys['a']||keys['arrowleft']) dx -= 1;
  if(keys['d']||keys['arrowright']) dx += 1;
  if(dx===0 && dy===0){ dx=1; }
  const m = Math.hypot(dx,dy);
  player.x += (dx/m) * 100;
  player.y += (dy/m) * 100;
  // damage enemies close by
  for(const e of enemies.slice()){ if(Math.hypot(e.x-player.x, e.y-player.y) < player.size + e.size + 12) e.takeDamage(2); }
}
function pulse(){
  const now = performance.now();
  if(now - lastPulse < 2000) return;
  lastPulse = now;
  if(!player) return;
  const r = 100;
  for(const e of enemies.slice()){
    if(Math.hypot(e.x-player.x, e.y-player.y) <= r) e.takeDamage(2);
  }
  spawnFloat(player.x, player.y-6, 'Pulse', '#ffd54f');
}

// Feeding: player presses F near queen to feed if colonyFood >= 5
function feedQueen(){
  if(gameState !== 'playing') return;
  if(!player) return;
  const d = Math.hypot(player.x - queen.x, player.y - queen.y);
  if(d <= 42 && colonyFood >= 5){
    colonyFood -= 5;
    queen.hunger = Math.min(queen.maxHunger, queen.hunger + 30);
    spawnFloat(queen.x, queen.y - 12, 'Queen Fed +30', '#ffd54f');
    showMsg('Fed the Queen +30');
    return;
  }
  showMsg('Be near the Queen and have Food to feed (F)');
}

// Game start / reset
function startGame(){
  // reset everything
  ants = []; enemies = []; foods = []; eggs = []; floats = []; crates = []; controllable = [];
  colonyFood = 0; score = 0; wave = 0; waveTimer = 0; timer = 0;
  // create queen (center)
  queen = new Ant(W/2, H/2, 'queen');
  queen.maxHealth = 30; queen.health = 30;
  queen.maxHunger = 300; queen.hunger = queen.maxHunger; queen.hungerDecay = 0.02; queen.layCooldown = 0;
  ants.push(queen);
  // create 3 starters: worker, soldier, scout
  const w = new Ant(W/2 + 60, H/2, 'worker');
  const s = new Ant(W/2 + 40, H/2 + 40, 'soldier');
  const sc = new Ant(W/2 - 60, H/2 + 10, 'scout');
  ants.push(w, s, sc);
  controllable.push(w, s, sc);
  playerIndex = 0; player = controllable[playerIndex];
  // spawn initial foods & enemies
  for(let i=0;i<8;i++) spawnFoodRandom();
  for(let i=0;i<3;i++) spawnEnemyRandom();
  // hide menus
  menuOverlay.style.display = 'none';
  instructionsOverlay.style.display = 'none';
  updatesOverlay.style.display = 'none';
  gameOverOverlay.style.display = 'none';
  gameState = 'playing';
  showMsg('Game started ‚Äî collect food and feed the Queen (F).');
}

// Menus
function showMenu(){
  menuOverlay.style.display = 'flex';
  instructionsOverlay.style.display = 'none';
  updatesOverlay.style.display = 'none';
  gameOverOverlay.style.display = 'none';
  gameState = 'menu';
}
function showInstructions(){
  instructionsOverlay.style.display = 'flex';
  menuOverlay.style.display = 'none';
}
function hideInstructions(){ instructionsOverlay.style.display = 'none'; menuOverlay.style.display = 'flex'; }
function showUpdates(){ updatesOverlay.style.display = 'flex'; menuOverlay.style.display = 'none'; }
function hideUpdates(){ updatesOverlay.style.display = 'none'; menuOverlay.style.display = 'flex'; }

// Game over
function gameOver(reason){
  gameState = 'gameover';
  document.getElementById('goText').textContent = reason || 'Your Queen has been lost.';
  goScore.textContent = Math.round(score);
  goWaves.textContent = wave;
  goAnts.textContent = ants.length;
  gameOverOverlay.style.display = 'flex';
}

// Main loop
let last = performance.now();
let spawnTick = 0, waveTick = 0;
function loop(now){
  requestAnimationFrame(loop);
  const dt = (now - last) / 16.666;
  last = now;
  if(gameState === 'menu' || gameState === 'gameover'){
    // draw background and preview items
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#f3e7c9'); g.addColorStop(1,'#7a4f34');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    for(const f of foods) f.draw();
    for(const a of ants) a.draw();
    for(const e of enemies) e.draw();
    return;
  }

  timer++; spawnTick++; waveTick++;

  // periodic spawns
  if(spawnTick % 120 === 0) spawnFoodRandom();
  if(spawnTick % 200 === 0) spawnEnemyRandom();

  // wave spawns
  if(waveTick >= waveInterval){
    waveTick = 0; wave++;
    const count = 2 + Math.floor(wave * 1.1);
    for(let i=0;i<count;i++) spawnEnemyRandom();
    showMsg('Wave ' + wave);
  }

  // queen hunger decay
  queen.hunger -= queen.hungerDecay;
  if(queen.hunger < 0) queen.hunger = 0;
  // if hunger 0, queen loses health over time
  if(queen.hunger <= 0){
    queen.health -= 0.02;
    if(queen.health <= 0){
      gameOver('The Queen starved to death.');
      return;
    }
  } else {
    // queen lays eggs when hungry enough and colony has food
    queen.layCooldown++;
    if(queen.hunger >= queen.maxHunger * 0.5 && queen.layCooldown > 750 && colonyFood >= 10){
      queen.layCooldown = 0;
      colonyFood -= 10;
      eggs.push(new Egg(queen.x + rand(-18,18), queen.y + rand(-18,18)));
      spawnFloat(queen.x, queen.y-12, 'Egg Laid', '#fff');
    }
  }

  // update entities
  for(const e of enemies) e.update();
  for(const eg of eggs) eg.update();
  for(const a of ants) a.update();

  // workers (and player) collect food by walking over pieces
  for(let i=foods.length-1;i>=0;i--){
    const f = foods[i];
    // player picks up: convert directly to colonyFood when player collides
    if(player && Math.hypot(player.x - f.x, player.y - f.y) < 12){
      colonyFood += f.amount;
      spawnFloat(f.x, f.y-8, '+' + f.amount + ' Food', '#ffd54f');
      foods.splice(i,1);
      continue;
    }
    // worker automatic pickup handled in Ant.update (worker removes food if picked); but also allow any ant to step on food and pick for simplicity:
    for(const a of ants){
      if(a.type === 'worker' && Math.hypot(a.x - f.x, a.y - f.y) < 10 && !f.picked){
        // worker picks up and will deposit in Ant.update (we removed in update after picking)
      }
    }
  }

  // floating text lifetime
  for(let i=floats.length-1;i>=0;i--){ floats[i].t++; if(floats[i].t > 80) floats.splice(i,1); }

  // draw
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#f3e7c9'); g.addColorStop(1,'#7a4f34');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // ground border (grass)
  ctx.fillStyle = 'rgba(30,120,50,0.08)';
  ctx.fillRect(0, H-60, W, 60);

  // draw foods, eggs, ants, enemies
  for(const f of foods) f.draw();
  for(const eg of eggs) eg.draw();
  for(const a of ants) a.draw();
  for(const e of enemies) e.draw();

  // draw floating texts
  for(const d of floats){ ctx.font = '14px sans-serif'; ctx.fillStyle = d.color; ctx.fillText(d.text, d.x, d.y - (d.t * 0.6)); d.t++; }

  // UI updates
  scoreEl.textContent = 'Score: ' + Math.round(score);
  colFoodEl.textContent = 'Food: ' + Math.round(colonyFood);
  activeTypeEl.textContent = 'Active: ' + (player ? player.type.toUpperCase() : '‚Äî');
  hpLineEl.textContent = player ? `HP: ${Math.round(player.health)}/${player.maxHealth}` : 'HP: ‚Äî';
  antsCountEl.textContent = ants.length;
  enemiesCountEl.textContent = enemies.length;
  qHealthEl.textContent = `HP: ${Math.round(queen.health)}/${queen.maxHealth}`;
  qHungerBar.style.width = (clamp(queen.hunger / queen.maxHunger, 0, 1) * 100) + '%';

  // check queen death by health fall
  if(queen.health <= 0){
    gameOver('The Queen has died.');
    return;
  }
}

// Helper drawing: rounded rect
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if(typeof r === 'undefined') r = 5;
  if(typeof r === 'number') r = {tl:r, tr:r, br:r, bl:r};
  ctx.beginPath();
  ctx.moveTo(x + r.tl, y);
  ctx.lineTo(x + w - r.tr, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
  ctx.lineTo(x + w, y + h - r.br);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
  ctx.lineTo(x + r.bl, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
  ctx.lineTo(x, y + r.tl);
  ctx.quadraticCurveTo(x, y, x + r.tl, y);
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

// Attack & abilities: Space to attack (player)
addEventListener('keydown', e => {
  if(gameState !== 'playing') return;
  if(e.key === ' ' && player){
    const power = 1;
    for(const en of enemies.slice()){
      if(Math.hypot(en.x - player.x, en.y - player.y) < player.size + en.size + 10){
        en.takeDamage(power);
      }
    }
  }
  if(e.key === 'Shift') dash();
  if(e.key === 'e' || e.key === 'E') pulse();
});

// menu helpers
showMenu(); // show main menu at load

// spawn some preview entities for menu
(function preview(){
  foods = []; ants = []; enemies = [];
  const q = new Ant(W/2, H/2, 'queen'); ants.push(q);
  const p1 = new Ant(W/2 + 60, H/2, 'worker'); const p2 = new Ant(W/2 + 40, H/2 + 40, 'soldier'); const p3 = new Ant(W/2 - 60, H/2 + 10, 'scout');
  ants.push(p1, p2, p3);
  foods.push(new Food(rand(80,W-80), rand(80,H-80), 5));
  enemies.push(new Enemy(rand(120,W-120), rand(120,H-120), 'spider'));
})();

// Start main loop
requestAnimationFrame(loop);

</script>
</body>
</html>
